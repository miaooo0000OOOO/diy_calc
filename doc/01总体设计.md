# 01 总体设计

## 设计要求

    主要功能：
    1.学习屏幕图形图案的绘制和字库的覆写，在屏幕上输出相应的内容。
    2.计算器可以完成简单的初等运算，并且运算时参照数学上的运算优先级。
    3.完善计算器细节的处理，如小数运算、负号和减号的区分等。

    辅助功能：
    1.学习启发式算法、设计能解出方程的至少一个根的算法。
    2.使用头文件<math.h>来设计数学中常用的三角、指对运算等。
    3.括号具有尽可能多的嵌套层数，最好可以无限制嵌套。
    
    发挥部分：
    1.增加计算器的拓展功能，如初等/高等数学常用的算符、算子。
    2.自行设计更多与计算器主题相符的功能。

## 根据设计要求所作的硬件选型

该项目采用一块触摸屏作为其输入输出设备，我认为有以下好处：

1. 可拓展性强，可以灵活变更界面布局
2. 显示效果好，色彩丰富，显示区域大
3. 硬件高度集成，便于设计外壳

该触摸屏有助于13个引脚，不便于使用杜邦线连接，为了系统稳定运行，我设计了一块插件PCB

综上，该项目的全部硬件包括：

1. STM32F103RCT6开发板
2. 自己画的插件PCB
3. 触摸屏模块

## 软件架构

该系统的软件包括：图形用户界面，显示屏驱动，字库和图形库，数学核心

### 图形用户界面的设计与实现

图形用户界面由显示区域和键盘区域组成，键盘布局参考卡西欧科学计算器的键盘布局，显示区域和键盘区域占比设计也主要参考卡西欧科学计算器。

GUI模块使用结构体定义了显示控件，包括屏幕控件`ShowScreen`和按钮控件`BUTTON4048`，实现了光标移动输入删除，按钮按下变色，按钮按下边沿触发。

使用GUI控件实现了局部动态刷新屏幕，提高了屏幕使用流畅度

### 显示屏驱动的改写

显示屏驱动由厂商提供，使用底层库，MDK工程，Windows操作系统开发，我将其改写为兼容HAL库和底层库的Makefile工程，使用Linux Ubuntu系统开发，可以使用STM32CubeMX配置。

在此，我简单介绍一下Linux嵌入式开发工具链：

    STM32CubeMX配置工程，选择使用Makefile编译工程

    使用arm-none-eabi-gcc交叉编译，主机平台x86_64，目标平台arm

    使用Makefile管理C项目

    使用vscode编程和调试

    使用openocd烧录

    使用gdb-multiarch和vscode上的cortex-debug拓展进行调试

为了移植触摸屏驱动，我做了以下工作：

1. 将底层库初始化的时钟，GPIO输入输出，硬件SPI配置移植到CubeMX上
2. 解决依赖问题和命名冲突
3. 理解触摸屏驱动原理，对性能要求较高的SPI读写依然保留了底层库，而其他部分使用了HAL库，兼具性能和开发效率
4. Windows使用GBK编码，Linux使用UTF-8编码，将GBK编码的字库驱动改为UTF-8的字库驱动
5. 对CubeMX生成的Makefile文件作出修改，管理编译依赖，生成可调试的二进制程序

## 字库和图形库的改写

Windows使用GBK编码，Linux使用UTF-8编码，一个GBK中文字符占2字节，一个UTF-8中文占3字节，因此移植过程中将UTF-8的字符比较改为3字节。

图形库由厂商提供，非常好用，没改。

## 数学核心的总体设计

参考编译原理的相关知识，输入字符串输出记号序列，输入记号序列输出抽象语法树，递归计算抽象语法树得出计算结果。

另一种实现方式是将表达式转化为后缀表达式，并使用栈进行计算，我认为这种方式的可拓展性不如抽象语法树。

将字符串转化为记号序列称为词法分析，将记号序列转化为抽象语法树称为解析

具体实现详见数学核心的文档